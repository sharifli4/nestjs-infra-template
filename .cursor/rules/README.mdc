# NestJS Infrastructure Template - AI Agent Rules

This is the master rules document for AI agents working on this NestJS project.

## ğŸ“š Rule Categories

This project has comprehensive rules organized by topic:

### 1. [exceptions.mdc](./exceptions.mdc) - Exception Handling Rules
- How to create and throw exceptions
- Exception types and HTTP status mapping
- Swagger documentation for exceptions
- Domain-specific exception patterns

### 2. [domain-architecture.mdc](./domain-architecture.mdc) - Domain-Centric Architecture
- Project structure rules
- NO common/utils folders
- Domain organization patterns
- Dependency direction rules

### 3. [configuration.mdc](./configuration.mdc) - Configuration Management
- Configuration isolation by domain
- Environment variable naming
- Type-safe configuration access
- Configuration validation

---

## ğŸ¯ Quick Reference

### Top 10 Rules (Never Break These!)

1. **NO `common/` or `utils/` folders** - Everything is domain-centric
2. **Never use raw NestJS exceptions** - Use BaseExceptionDto system
3. **Configuration isolation** - Each domain has its own config namespace
4. **No cross-domain dependencies** - Features can't depend on other features
5. **All exceptions use ExceptionTypeEnum** - Standardized error types
6. **Domain prefix for env vars** - `USERS_`, `NOTIFICATIONS_`, etc.
7. **Use design patterns** - Factory, Builder, Strategy for modules
8. **Document with Swagger** - Use `@ApiCustomExceptionResponse`
9. **Type everything** - Interfaces for configs, DTOs, exceptions
10. **Test your code** - Tests live with their code in domain folders

---

## ğŸ—ï¸ Project Architecture Overview

```
src/
â”œâ”€â”€ core/                    # Core infrastructure ONLY
â”‚   â”œâ”€â”€ exceptions/          # Exception handling system
â”‚   â”œâ”€â”€ factories/           # Module loading patterns
â”‚   â”œâ”€â”€ guards/              # Auth guards
â”‚   â””â”€â”€ decorators/          # Cross-domain decorators
â”‚
â”œâ”€â”€ config/                  # Infrastructure configs
â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”œâ”€â”€ redis.config.ts
â”‚   â””â”€â”€ logger.config.ts
â”‚
â”œâ”€â”€ database/                # Base entities
â”œâ”€â”€ logger/                  # Logging infrastructure
â”œâ”€â”€ redis/                   # Caching infrastructure
â”‚
â””â”€â”€ features/                # ALL BUSINESS DOMAINS
    â”œâ”€â”€ users/
    â”‚   â”œâ”€â”€ config/          # Domain config
    â”‚   â”œâ”€â”€ entities/        # Domain entities
    â”‚   â”œâ”€â”€ dto/             # Domain DTOs
    â”‚   â”œâ”€â”€ exceptions/      # Domain exceptions
    â”‚   â”œâ”€â”€ services/        # Business logic
    â”‚   â”œâ”€â”€ controllers/     # HTTP endpoints
    â”‚   â”œâ”€â”€ tests/           # Domain tests
    â”‚   â””â”€â”€ users.module.ts
    â”‚
    â””â”€â”€ [other-domains]/
```

---

## ğŸ¨ Design Patterns Used

### Factory Pattern
- `DatabaseModuleFactory` - Creates database modules
- `RedisModuleFactory` - Creates Redis modules
- `ConfigurationLoaderFactory` - Creates config loaders

### Builder Pattern
- `InfrastructureModuleBuilder` - Fluent module loading

### Strategy Pattern
- `ModuleLoadStrategy` - Runtime module loading decisions

See [DESIGN_PATTERNS.md](../DESIGN_PATTERNS.md) for details.

---

## ğŸ“ Code Examples

### Creating a New Exception

```typescript
// src/features/users/exceptions/user-not-verified.exception.ts
import { HttpException, HttpStatus } from '@nestjs/common';
import { ExceptionTypeEnum, BaseExceptionDto } from '@/core/exceptions';

export class UserNotVerifiedException extends HttpException {
  constructor(userId: string) {
    const baseExceptionDto = BaseExceptionDto.CreateBaseException(
      [userId],
      HttpStatus.FORBIDDEN,
      ExceptionTypeEnum.FORBIDDEN,
      'Email verification required to perform this action',
    );
    super(baseExceptionDto, HttpStatus.FORBIDDEN);
  }
}
```

### Creating a New Domain Configuration

```typescript
// src/features/users/config/users.config.ts
import { registerAs } from '@nestjs/config';

export interface UsersConfig {
  maxLoginAttempts: number;
  lockoutDuration: number;
}

export default registerAs('users', (): UsersConfig => ({
  maxLoginAttempts: parseInt(process.env.USERS_MAX_LOGIN_ATTEMPTS || '5', 10),
  lockoutDuration: parseInt(process.env.USERS_LOCKOUT_DURATION || '900', 10),
}));
```

### Creating a New Feature Domain

```bash
# 1. Create domain folder structure
src/features/orders/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ orders.config.ts
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ order.entity.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-order.dto.ts
â”‚   â””â”€â”€ update-order.dto.ts
â”œâ”€â”€ exceptions/
â”‚   â””â”€â”€ order-not-found.exception.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ orders.service.ts
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ orders.controller.ts
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ orders.service.spec.ts
â””â”€â”€ orders.module.ts
```

```typescript
// 2. Create module
// src/features/orders/orders.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import ordersConfig from './config/orders.config';

@Module({
  imports: [
    ConfigModule.forFeature(ordersConfig),
  ],
  controllers: [OrdersController],
  providers: [OrdersService],
  exports: [OrdersService],
})
export class OrdersModule {}

// 3. Register in app.module.ts
@Module({
  imports: [
    // ... other imports
    OrdersModule,
  ],
})
export class AppModule {}
```

---

## âœ… Checklist for New Features

When creating a new feature:

- [ ] Create folder in `src/features/{domain-name}/`
- [ ] Add domain configuration in `config/`
- [ ] Use domain prefix for env vars (e.g., `ORDERS_`)
- [ ] Create entities extending `BaseEntity`
- [ ] Create DTOs with validation decorators
- [ ] Create domain-specific exceptions
- [ ] Use `@ApiCustomExceptionResponse` in controllers
- [ ] Register config with `ConfigModule.forFeature()`
- [ ] Access only own domain's configuration
- [ ] Add tests in `tests/` folder
- [ ] Export module in `app.module.ts`
- [ ] Update `.env.example`

---

## ğŸš« Common Anti-Patterns to Avoid

### âŒ Don't Create Shared Folders
```typescript
âŒ src/common/
âŒ src/utils/
âŒ src/helpers/
âŒ src/shared/
```

### âŒ Don't Use Raw NestJS Exceptions
```typescript
âŒ throw new BadRequestException('Error');
âŒ throw new NotFoundException('Not found');
âœ… throw new UserNotFoundException(userId);
```

### âŒ Don't Access Other Domain Configs
```typescript
// In UsersService
âŒ const smtp = this.configService.get<NotificationsConfig>('notifications');
âœ… const config = this.configService.get<UsersConfig>('users');
```

### âŒ Don't Create Cross-Domain Dependencies
```typescript
// In OrdersService
âŒ constructor(private usersService: UsersService) {}
âœ… Use events or create core service
```

---

## ğŸ“ Learning Resources

### Project Documentation
- [README.md](../README.md) - Getting started guide
- [spec.md](../spec.md) - Complete specification
- [DESIGN_PATTERNS.md](../DESIGN_PATTERNS.md) - Design patterns explained
- [OPTIONAL_FEATURES.md](../OPTIONAL_FEATURES.md) - Optional infrastructure guide
- [IMPLEMENTATION.md](../IMPLEMENTATION.md) - Implementation summary

### External Resources
- [NestJS Documentation](https://docs.nestjs.com)
- [MikroORM Documentation](https://mikro-orm.io)
- [Domain-Driven Design](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)

---

## ğŸ¤ Working with This Project

### For AI Agents

1. **Read the rules** - Familiarize yourself with all rule files
2. **Follow patterns** - Use existing code as examples
3. **Domain-first thinking** - Always ask "which domain does this belong to?"
4. **Type safety** - Use TypeScript features for type checking
5. **Test your code** - Write tests alongside implementation
6. **Document exceptions** - Use Swagger decorators
7. **Ask when unsure** - Better to clarify than break patterns

### Code Review Checklist

When reviewing or creating code:

- [ ] No `common/` or `utils/` folders created
- [ ] Exceptions use `BaseExceptionDto`
- [ ] All exceptions documented with Swagger
- [ ] Configuration uses `registerAs` with namespace
- [ ] Env vars have domain prefixes
- [ ] No cross-domain dependencies
- [ ] Tests included
- [ ] Types defined for everything
- [ ] Follows existing patterns

---

## ğŸ“ Questions?

If you're unsure about:
- **Where to put code** â†’ Check [domain-architecture.mdc](./domain-architecture.mdc)
- **How to handle errors** â†’ Check [exceptions.mdc](./exceptions.mdc)
- **How to add config** â†’ Check [configuration.mdc](./configuration.mdc)
- **Design patterns** â†’ Check [DESIGN_PATTERNS.md](../DESIGN_PATTERNS.md)

---

## ğŸ¯ Remember

This project follows:
- âœ… Domain-Driven Design
- âœ… SOLID Principles
- âœ… Design Patterns (Factory, Builder, Strategy)
- âœ… Configuration Isolation
- âœ… Type Safety
- âœ… Comprehensive Error Handling
- âœ… Clean Architecture

**Quality over speed. Maintainability over convenience.**
